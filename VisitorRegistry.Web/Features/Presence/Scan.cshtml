@{
    var mode = (ViewBag.Mode as string) ?? "in";
    var message = ViewBag.Message as string;
    var success = ViewBag.Success as bool? ?? false;

    bool isCheckIn = mode == "in";
}

<div class="container">
    <div class="row justify-content-center align-items-center min-vh-100">
        <div class="col-12 col-md-6 col-lg-5">

            <h2 class="text-center mb-3 fw-bold">
                Identificazione visitatore
            </h2>


            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert @(success ? "alert-success" : "alert-danger") text-center">
                    @message
                </div>
            }

            <div class="card shadow-sm">
                <div class="card-body">

                    <!-- Area Scanner -->
                    <div id="scannerArea"
                         class="border border-2 rounded text-center p-3 mb-4">

                        <div id="qr-reader" style="width:100%; min-height:260px;"></div>

                        <small id="scannerHint" class="text-muted d-block mt-1">
                            Clicca qui per attivare la fotocamera 
                        </small>

                        <p id="scanFeedback" class="text-success fw-semibold text-center mt-2 d-none"> </p>
                    </div>

                    <div class="text-center text-muted mb-3">oppure</div>

                    <!-- Form -->
                    <form asp-action="ProcessScan" method="post" id="scanForm">

                        <div class="mb-3">
                            <label for="qrCode" class="form-label">
                                Inserisci Manualmente
                            </label>
                            <input type="text" id="qrCode" name="qrCode" class="form-control" placeholder="Digita il codice QR" required />
                        </div>

                        <button type="submit"
                                class="btn w-100 btn-primary">
                            Conferma 
                        </button>
                    </form>

                    <div class="text-center mt-3">
                        <small>
                           
                        </small><br />
                        
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="scanToast"
         class="toast align-items-center text-bg-danger border-0"
         role="alert"
         aria-live="assertive"
         aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="scanToastMessage">
                <!-- testo dinamico -->
            </div>
            <button type="button"
                    class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    const qrInput = document.getElementById('qrCode');
    const form = document.getElementById('scanForm');
    const scannerArea = document.getElementById('scannerArea');
    const scannerHint = document.getElementById('scannerHint');
    const feedback = document.getElementById("scanFeedback");

    let html5QrCode = null;
    let isScanning = false;

    function onScanSuccess(decodedText) {
        if (!isScanning) return;

        isScanning = false; // ?? BLOCCA SUBITO

        qrInput.value = decodedText;
        qrInput.readOnly = true;

        scannerHint.innerText = "?? Badge riconosciuto";
        feedback.innerText = "Badge letto correttamente";
        feedback.classList.remove("d-none", "text-danger");
        feedback.classList.add("text-success");

        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            form.submit();
        });
    }

    function startScanner() {
        if (isScanning) return;

        html5QrCode = new Html5Qrcode("qr-reader");
        scannerHint.innerText = "Fotocamera attiva, inquadra il badge";

        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onScanSuccess
        ).then(() => {
            isScanning = true;
            console.log("?? Scanner avviato");
        }).catch(err => {
            console.error("Errore scanner:", err);
        });
    }

    function stopScanner() {
        if (!html5QrCode || !isScanning) return;

        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            isScanning = false;
            scannerHint.innerText = "Clicca qui per attivare la fotocamera";
        });
    }

    scannerArea.addEventListener('click', startScanner);
    qrInput.addEventListener('focus', stopScanner);
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const msg = '@ViewBag.ToastMessage';

        if (msg) {
            document.getElementById('scanToastMessage').innerText = msg;
            const toast = new bootstrap.Toast(
                document.getElementById('scanToast'),
                { delay: 5000 }
            );
            toast.show();
        }
    });
</script>



