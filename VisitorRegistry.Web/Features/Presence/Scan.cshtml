@{
    var mode = (ViewBag.Mode as string) ?? "in";
    var message = ViewBag.Message as string;
    var success = ViewBag.Success as bool? ?? false;

    bool isCheckIn = mode == "in";
}

<div class="container">
    <div class="row justify-content-center align-items-center min-vh-100">
        <div class="col-12 col-md-6 col-lg-5">

            <h2 class="text-center mb-3 fw-bold">
                Identificazione visitatore
            </h2>


            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert @(success ? "alert-success" : "alert-danger") text-center">
                    @message
                </div>
            }

            <div class="card shadow-sm">
                <div class="card-body">

                    <!-- Area Scanner -->
                    <div id="scannerArea"
                         class="border border-2 rounded text-center p-3 mb-4">

                        <div id="qr-reader" style="width:100%;"></div>

                        <small id="scannerHint" class="text-muted d-block mt-1">
                            Clicca qui per attivare la fotocamera 
                        </small>

                        <p id="scanFeedback" class="text-success fw-semibold text-center mt-2 d-none"> </p>
                    </div>

                    <div class="text-center text-muted mb-3">oppure</div>

                    <!-- Form -->
                    <form asp-action="ProcessScan" method="post" id="scanForm">

                        <div class="mb-3">
                            <label for="qrCode" class="form-label">
                                Inserisci Manualmente
                            </label>
                            <input type="text" id="qrCode" name="qrCode" class="form-control" placeholder="Digita il codice QR" required />
                        </div>

                        <button type="submit"
                                class="btn w-100 btn-primary">
                            Conferma 
                        </button>
                    </form>

                    <div class="text-center mt-3">
                        <small>
                           
                        </small><br />
                        
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    const qrInput = document.getElementById('qrCode');
    const form = document.getElementById('scanForm');
    const scannerArea = document.getElementById('scannerArea');
    const scannerHint = document.getElementById('scannerHint');

    let html5QrCode = null;
    let scannerRunning = false;

    function onScanSuccess(decodedText) {
        // valorizza input
        qrInput.value = decodedText;

        // feedback visivo
        scannerHint.innerText = "?? Badge riconosciuto";
        const feedback = document.getElementById("scanFeedback");
        feedback.innerText = "Badge letto correttamente";
        feedback.classList.remove("d-none");
        feedback.classList.remove("text-danger");
        feedback.classList.add("text-success");

        // blocca input per evitare doppie scansioni
        qrInput.disabled = true;

        // ferma scanner e invia
        stopScanner().then(() => {
            form.submit();
        });
    }


    function startScanner() {
        if (scannerRunning) return;

        html5QrCode = new Html5Qrcode("qr-reader");

        scannerHint.innerText = "Fotocamera attiva, inquadra il badge";

        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onScanSuccess
        ).then(() => {
            scannerRunning = true;
        }).catch(err => {
            console.error("Errore scanner:", err);
        });
    }

    function stopScanner() {
        if (!html5QrCode || !scannerRunning) {
            scannerHint.innerText = "Clicca qui per attivare la fotocamera";
            return Promise.resolve();
        }

        return html5QrCode.stop().then(() => {
            html5QrCode.clear();
            scannerRunning = false;
            scannerHint.innerText = "Clicca qui per attivare la fotocamera";
        });
    }

    // webcam ON
    scannerArea.addEventListener('click', startScanner);

    // webcam OFF quando si usa la tastiera
    qrInput.addEventListener('focus', stopScanner);

@if (!string.IsNullOrEmpty(ViewBag.Message) && ViewBag.Success == false)
{
    <text>
        const feedback = document.getElementById("scanFeedback");
        feedback.innerText = "? Codice QR non valido";
        feedback.classList.remove("d-none");
        feedback.classList.remove("text-success");
        feedback.classList.add("text-danger");

        qrInput.disabled = false;
        qrInput.value = "";
        qrInput.focus();
    </text>
}

</script>


